/**
 * Displays and manages a user's list of allergies with persistent storage and swipe-to-delete functionality.
 *
 * Allergies are loaded from local storage using a key tied to the authenticated user's ID.
 * Users can add new allergies via a picker and remove existing ones by swiping left.
 * The list is rendered with separators and optional images or descriptions.
 *
 * Generated by Copilot AI
 */

import React, { useState, useEffect, useContext } from "react";
import { FlatList, StyleSheet, View } from "react-native";
import AuthContext from "../auth/context";
import AppPicker from "../components/AppPicker";
import AppText from "../components/AppText";

import {
  ListItem,
  ListItemDeleteAction,
  ListItemSeparator,
} from "../components/lists/index";
import ScreenFlexible from "../components/ScreenFlexible";
import colors from "../config/colors";
import choices from "../config/options";
import sstore from "../utility/sstore";

let initialItems = [];

const allergyChoices = choices.allergyChoices;

function AccountAllergies(props) {
  const authContext = useContext(AuthContext);
  const key = authContext.user.uid + "allergies";
  const [allergies, setAllergies] = useState(initialItems);

  useEffect(() => {
    loadAllergies();
  }, []);

  const loadAllergies = async () => {
    const response = await sstore.get(key);
    setAllergies(response);
  };

  const handleDelete = (allergy) => {
    // Delete the item from item
    const updated = allergies.filter((m) => m.id !== allergy.id);
    sstore.store(key, updated);
    setAllergies(updated);
  };

  const onSelectItem = (allergy) => {
    //console.log(allergies);
    if (allergies.includes(allergy)) {
      setAllergies(allergies);
    } else {
      const updated = JSON.parse(JSON.stringify(allergies));
      updated.push(allergy);
      sstore.store(key, updated);
      setAllergies(updated);
    }
  };

  return (
    <ScreenFlexible style={styles.screen}>
      {/* Layout wrapper to position tooltip outside scroll area */}
      <View style={styles.container}>
        <View style={styles.listWrapper}>
          <AppPicker
            placeholder="Add Allergy"
            items={allergyChoices}
            onSelectItem={onSelectItem}
          />

          <FlatList
            data={allergies}
            keyExtractor={(allergy) => allergy.id.toString()}
            renderItem={({ item }) => (
              <ListItem
                title={item.label}
                subTitle={item.description}
                titleStyle={{ paddingLeft: 0 }}
                image={item.image}
                renderRightActions={() => (
                  <ListItemDeleteAction onPress={() => handleDelete(item)} />
                )}
                swipeable
                showChevron={false} 
              />
            )}
            ItemSeparatorComponent={ListItemSeparator}
            contentContainerStyle={styles.listContent}
          />
        </View>

        {/* Tooltip BELOW the list (not overlapping) */}
        <View style={styles.toolTipContainer}>
          <AppText style={styles.toolTipText}>Swipe left to remove allergies</AppText>
        </View>
      </View>
    </ScreenFlexible>
  );
}

const TOOLTIP_HEIGHT = 90;

const styles = StyleSheet.create({
  screen: {
    backgroundColor: colors.light,
    flex: 1,
  },
  container: {
    flex: 1,
    paddingTop: 30, // moves top of the list lower on screen
  },
  listWrapper: {
    flex: 1,
    marginBottom: TOOLTIP_HEIGHT, // reserve space for tooltip
  },
  listContent: {
    paddingBottom: 45, // adds padding at the end of the list
  },
  toolTipContainer: {
    height: TOOLTIP_HEIGHT,
    bottom: "15%", // can also do "bottom: 100" - space between bottom of toolTip and bottom of screen
    alignItems: "center",
    justifyContent: "center",
    backgroundColor: colors.light,
    // borderTopWidth: StyleSheet.hairlineWidth,
    borderColor: colors.medium,
  },
  toolTipText: {
    color: colors.primary,
    fontSize: 22,
  },
});

export default AccountAllergies;
